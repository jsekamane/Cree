/* cloak client */
!function(a,b){"function"==typeof a.define&&a.define.amd?define(["underscore","socket.io-client"],b):"object"==typeof module&&module.exports?module.exports=b(require("underscore"),require("socket.io-client")):a.cloak=b(a._,a.io)}(this,function(a,b){var c=function(a,b,c){delete c[b]},d=function(){var d,e,f,g={},h={},i={},j={configure:function(b){e&&b.messages&&a(h.messages).forEach(function(a,b){e.removeListener("message-"+b),j._off("message-"+b,a)}),a.extend(h,b),e&&j._applyConfig(h)},_applyConfig:function(b){a(b.messages).forEach(function(a,b){e.on("message-"+b,function(a){j._trigger("message-"+b,a)}),j._on("message-"+b,a)}),a(b.serverEvents).forEach(function(a,b){j._on("cloak-"+b,a)}),a.extend(i,b.timerEvents)},_on:function(a,b){void 0===g[a]&&(g[a]=[]),g[a].push(b)},_off:function(b,c){g[b]=a(g[b]).without(c)},_trigger:function(b,c){void 0!==g[b]&&a.forEach(g[b],function(a){a(c)})},run:function(c,g){void 0===g&&(g={});var k={"force new connection":!0};g.socketIo&&(k=a.extend(k,g.socketIo)),e=b.connect(c,k),e.on("error",function(a){j._trigger("cloak-error",a)}),e.on("connect_error",function(){j._trigger("cloak-error","Connect error")}),e.on("connect_timeout",function(){j._trigger("cloak-error","Connect timeout")}),e.on("connect",function(){void 0===d?e.emit("cloak-begin",h.initialData||{}):e.emit("cloak-resume",{uid:d})}),e.on("disconnect",function(){j._trigger("cloak-disconnect")}),e.on("connecting",function(){j._trigger("cloak-connecting")}),e.on("cloak-roomMemberJoined",function(a){j._trigger("cloak-roomMemberJoined",a)}),e.on("cloak-roomMemberLeft",function(a){j._trigger("cloak-roomMemberLeft",a)}),e.on("cloak-lobbyMemberJoined",function(a){j._trigger("cloak-lobbyMemberJoined",a)}),e.on("cloak-lobbyMemberLeft",function(a){j._trigger("cloak-lobbyMemberLeft",a)}),e.on("cloak-joinedRoom",function(a){j._trigger("cloak-joinedRoom",a)}),e.on("cloak-leftRoom",function(a){j._trigger("cloak-leftRoom",a)}),e.on("cloak-roomCreated",function(a){j._trigger("cloak-roomCreated",a)}),e.on("cloak-roomDeleted",function(a){j._trigger("cloak-roomDeleted",a)}),e.on("cloak-beginResponse",function(a){d=a.uid,f=a.config,j._trigger("cloak-begin")}),e.on("cloak-resumeResponse",function(a){a.valid?(f=a.config,j._trigger("cloak-resume")):(j._trigger("cloak-error","Could not resume."),j.stop())}),e.on("cloak-syncTimer",function(a){var b=i[a.name];if(void 0!==b){var c=a.value;a.running&&a.descending?c-=(new Date).getTime()-a.sent:a.running&&(c+=(new Date).getTime()-a.sent),b(c)}}),j._applyConfig(h)},stop:function(){this._disconnect(),j._trigger("cloak-end"),e.removeAllListeners(),a.forEach(g,c),a.forEach(i,c),e=null,d=void 0},_disconnect:function(){e.disconnect()},_connect:function(){e.socket.connect()},connected:function(){return e&&e.socket.connected},currentUser:function(){return d},message:function(a,b){if(!this.connected())throw"Not connected.";e.emit("message-"+a,b)}};return j};return d()});